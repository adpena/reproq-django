<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reproq Django | Documentation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        code, pre { font-family: 'JetBrains Mono', monospace; }
        .prose pre { background-color: #1e293b; color: #f8fafc; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; }
        .gradient-text { background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 leading-relaxed">
    <div class="flex min-h-screen">
        <!-- Sidebar -->
        <aside class="w-64 bg-white border-r border-slate-200 hidden md:block sticky top-0 h-screen overflow-y-auto">
            <div class="p-6">
                <h1 class="text-2xl font-bold gradient-text">Reproq</h1>
                <p class="text-xs text-slate-500 font-semibold tracking-widest uppercase mt-1">Django Tasks</p>
            </div>
            <nav class="px-4 pb-6 space-y-1">
                <a href="#overview" class="block px-3 py-2 text-sm font-medium rounded-md hover:bg-slate-100 text-slate-700">Overview</a>
                <a href="#why" class="block px-3 py-2 text-sm font-medium rounded-md hover:bg-slate-100 text-slate-700">Why Reproq</a>
                <a href="#quickstart" class="block px-3 py-2 text-sm font-medium rounded-md hover:bg-slate-100 text-slate-700">Quickstart</a>
                <a href="#configuration" class="block px-3 py-2 text-sm font-medium rounded-md hover:bg-slate-100 text-slate-700">Configuration</a>
                <div class="pt-4 pb-2 text-xs font-semibold text-slate-400 uppercase tracking-wider px-3">Advanced</div>
                <a href="#architecture" class="block px-3 py-2 text-sm font-medium rounded-md hover:bg-slate-100 text-slate-700">Architecture</a>
                <a href="#lock-key" class="block px-3 py-2 text-sm font-medium rounded-md hover:bg-slate-100 text-slate-700">Concurrency (Lock Key)</a>
                <a href="#workflows" class="block px-3 py-2 text-sm font-medium rounded-md hover:bg-slate-100 text-slate-700">Workflows (Chains)</a>
                <a href="#determinism" class="block px-3 py-2 text-sm font-medium rounded-md hover:bg-slate-100 text-slate-700">Determinism & Dedup</a>
                <a href="#payloads" class="block px-3 py-2 text-sm font-medium rounded-md hover:bg-slate-100 text-slate-700">Large Payloads</a>
                <a href="#periodic" class="block px-3 py-2 text-sm font-medium rounded-md hover:bg-slate-100 text-slate-700">Periodic Tasks</a>
                <a href="#rate-limits" class="block px-3 py-2 text-sm font-medium rounded-md hover:bg-slate-100 text-slate-700">Rate Limiting</a>
                <a href="#scaling" class="block px-3 py-2 text-sm font-medium rounded-md hover:bg-slate-100 text-slate-700">Scaling</a>
                <a href="#production" class="block px-3 py-2 text-sm font-medium rounded-md hover:bg-slate-100 text-slate-700">Production (systemd)</a>
                <a href="https://github.com/adpena/reproq-django/blob/main/RENDER.md" class="block px-3 py-2 text-sm font-medium rounded-md hover:bg-slate-100 text-slate-700">Production (Render)</a>
                <div class="pt-4 pb-2 text-xs font-semibold text-slate-400 uppercase tracking-wider px-3">Monitoring</div>
                <a href="#admin" class="block px-3 py-2 text-sm font-medium rounded-md hover:bg-slate-100 text-slate-700">Dashboard & Admin</a>
                <a href="#metrics" class="block px-3 py-2 text-sm font-medium rounded-md hover:bg-slate-100 text-slate-700">Prometheus Metrics</a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 max-w-4xl mx-auto px-6 py-12 md:px-12">
            <section id="overview" class="mb-16">
                <h2 class="text-4xl font-extrabold text-slate-900 mb-4 tracking-tight">Deterministic background tasks for Django.</h2>
                <p class="text-xl text-slate-600 mb-8">Reproq is a production-grade tasks backend that combines the ease of Django with the performance and reliability of a Go-based runner.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="p-4 bg-white border border-slate-200 rounded-xl shadow-sm">
                        <h3 class="font-bold text-indigo-600 mb-1">Postgres-Only</h3>
                        <p class="text-sm text-slate-500">No Redis or RabbitMQ required. Uses SKIP LOCKED for high-performance claiming.</p>
                    </div>
                    <div class="p-4 bg-white border border-slate-200 rounded-xl shadow-sm">
                        <h3 class="font-bold text-indigo-600 mb-1">Deterministic</h3>
                        <p class="text-sm text-slate-500">Stable spec hashing ensures you never run the same job twice unintentionally.</p>
                    </div>
                </div>
            </section>

            <section id="why" class="mb-16">
                <h2 class="text-3xl font-bold mb-6">Why Reproq</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="p-4 bg-white border border-slate-200 rounded-xl">
                        <h3 class="font-bold text-indigo-600 mb-1">Postgres Only</h3>
                        <p class="text-sm text-slate-500">No Redis or RabbitMQ. One database, one worker.</p>
                    </div>
                    <div class="p-4 bg-white border border-slate-200 rounded-xl">
                        <h3 class="font-bold text-indigo-600 mb-1">Deterministic</h3>
                        <p class="text-sm text-slate-500">Deduplication via spec hashing reduces accidental duplicates.</p>
                    </div>
                </div>
                <p class="text-sm text-slate-600 mt-4">If you need complex routing or multi-broker support, Celery may still fit better. Reproq optimizes for clarity, determinism, and low operational overhead.</p>
            </section>

            <section id="quickstart" class="mb-16 prose prose-slate max-w-none">
                <h2 class="text-3xl font-bold mb-6">Quickstart</h2>
                <p>Install the package and bootstrap the environment in a few steps.</p>
                
                <h4 class="font-bold mt-4">1. Install</h4>
                <pre>uv pip install reproq-django
# or: pip install reproq-django</pre>

                <h4 class="font-bold mt-4">2. Configure</h4>
                <p>Add to <code>INSTALLED_APPS</code> and set your <code>TASKS</code> backend.</p>
                <pre>INSTALLED_APPS = [
    ...,
    "reproq_django",
]

TASKS = {
    "default": {
        "BACKEND": "reproq_django.backend.ReproqBackend",
    }
}</pre>

                <h4 class="font-bold mt-4">3. Define a Task</h4>
                <pre>from django.tasks import task

@task(queue_name="default", priority=0)
def send_welcome_email(user_id):
    return f"Email sent to {user_id}"</pre>
                <p class="mt-3 text-sm text-slate-600">In async (ASGI) contexts, use <code>aenqueue()</code> to avoid blocking.</p>

                <h4 class="font-bold mt-4">4. Bootstrap</h4>
                <p>Run the init command to download the Go worker and write a config file.</p>
                <pre>python manage.py reproq init</pre>

                <h4 class="font-bold mt-4">5. Migrate</h4>
                <p>Run worker schema setup before Django migrations.</p>
                <pre>python manage.py reproq migrate-worker
python manage.py migrate --noinput</pre>

                <h4 class="font-bold mt-4">6. Run the Worker</h4>
                <pre>python manage.py reproq worker</pre>

                <h4 class="font-bold mt-4">7. (Optional) Schedule Periodic Tasks</h4>
                <p>Choose one scheduler: beat or pg_cron.</p>
                <pre>python manage.py reproq beat
python manage.py reproq pg-cron --install</pre>
            </section>

            <section id="management" class="mb-16 prose prose-slate max-w-none">
                <h2 class="text-3xl font-bold mb-6">Management Commands</h2>
                <p>Run <code>python manage.py reproq &lt;subcommand&gt;</code> for worker lifecycle and ops.</p>
                <ul>
                    <li><strong>init</strong>: Write <code>reproq.yaml</code>/<code>reproq.toml</code>, install the worker, and run migrations.</li>
                    <li><strong>worker</strong>: Start the Go worker process.</li>
                    <li><strong>beat</strong>: Start the periodic task scheduler (one per database).</li>
                    <li><strong>pg-cron</strong>: Sync Postgres-native schedules via <code>pg_cron</code>.</li>
                    <li><strong>migrate-worker</strong>: Apply worker indexes and schema helpers.</li>
                    <li><strong>doctor</strong>: Validate DSN, schema, worker binary, and allowlist health.</li>
                    <li><strong>config --explain</strong>: Print the effective config with precedence.</li>
                    <li><strong>upgrade</strong>: Fetch the latest worker release and run <code>migrate-worker</code>.</li>
                    <li><strong>allowlist --write</strong>: Persist discovered task modules into the config file.</li>
                    <li><strong>reclaim</strong>: Requeue or fail tasks with expired leases.</li>
                    <li><strong>status / logs / cancel</strong>: Quick ops helpers for triage.</li>
                </ul>
                <p class="text-sm text-slate-600">Precedence: defaults &lt; config file &lt; env vars &lt; CLI flags. <code>--dsn</code> overrides <code>DATABASE_URL</code>.</p>
            </section>

            <section id="architecture" class="mb-16 prose prose-slate max-w-none">
                <h2 class="text-3xl font-bold mb-6">Architecture</h2>
                <p>Reproq follows a "split-brain" architecture to maximize both developer productivity and runtime performance.</p>
                <ul>
                    <li><strong>Reproq Django (The Brain)</strong>: Responsible for task definition, enqueuing, and the monitoring UI.</li>
                    <li><strong>Reproq Worker (The Muscle)</strong>: A standalone Go binary that polls PostgreSQL and executes tasks in isolated processes.</li>
                    <li><strong>Scheduler (Beat or pg_cron)</strong>: Either a lightweight beat process or Postgres-native cron jobs.</li>
                    <li><strong>PostgreSQL (The Broker)</strong>: The single source of truth for task state and worker health.</li>
                </ul>
            </section>

            <section id="lock-key" class="mb-16 prose prose-slate max-w-none">
                <h2 class="text-3xl font-bold mb-6">Concurrency Control</h2>
                <p>Prevent multiple tasks from operating on the same resource simultaneously using <code>lock_key</code>.</p>
                <pre>from django.tasks import task

@task
def process_invoice(invoice_id):
    # Logic here
    pass

# This ensures only one invoice_123 task runs at a time
process_invoice.enqueue(123, lock_key="invoice_123")</pre>
            </section>

            <section id="workflows" class="mb-16 prose prose-slate max-w-none">
                <h2 class="text-3xl font-bold mb-6">Workflows (Chains &amp; Groups)</h2>
                <p>Execute tasks in sequence using <code>chain</code>. Each task waits for the previous one to complete successfully.</p>
                <pre>from reproq_django.workflows import chain

chain(task_a, task_b, task_c).enqueue()</pre>
                <p>Use <code>group</code> to enqueue tasks in parallel, or <code>chord</code> to run a callback after a group finishes.</p>
                <p>The callback runs only after all group tasks succeed; failures mark the workflow failed and the callback will not run.</p>
            </section>

            <section id="retries" class="mb-16 prose prose-slate max-w-none">
                <h2 class="text-3xl font-bold mb-6">Retries &amp; Backoff</h2>
                <p>The Go worker handles retries. When a task fails and attempts remain, the worker re-queues it with an exponential backoff.</p>
                <ul>
                    <li>Base delay: 30 seconds</li>
                    <li>Backoff: <code>2^attempt</code> (attempt starts at 1)</li>
                    <li>Max delay: 1 hour</li>
                </ul>
                <p>Backoff is applied via the <code>run_after</code> field, so tasks are only claimed once they are due.</p>
            </section>

            <section id="determinism" class="mb-16 prose prose-slate max-w-none">
                <h2 class="text-3xl font-bold mb-6">Determinism & Deduplication</h2>
                <p>Reproq features a powerful deterministic execution model based on <strong>Specification Hashing</strong>.</p>
                <p>When you enqueue a task, Reproq generates a SHA256 hash of the task name, arguments, and queue. If <code>DEDUP_ACTIVE</code> is enabled, identical tasks that are already <code>READY</code> or <code>RUNNING</code> will be coalesced, preventing redundant work.</p>
                <pre>TASKS = {
    "default": {
        "BACKEND": "reproq_django.backend.ReproqBackend",
        "OPTIONS": { "DEDUP_ACTIVE": True }
    }
}</pre>
                <p class="text-sm text-slate-600">The spec hash includes scheduling metadata such as <code>priority</code>, <code>run_after</code>, and <code>lock_key</code>, so changes to those fields intentionally bypass deduplication.</p>
                <p>To force a unique run, include a unique identifier in the task arguments.</p>
                <pre>import uuid

deploy_id = str(uuid.uuid4())
notify_deploy_success.enqueue(deploy_id=deploy_id)</pre>
                <p>For safer deploys, consider accepting <code>**kwargs</code> so older workers can ignore new fields.</p>
                <pre>@task
def send_welcome_email(user_id, **_kwargs):
    return f"Email sent to {user_id}"</pre>
            </section>

            <section id="payloads" class="mb-16 prose prose-slate max-w-none">
                <h2 class="text-3xl font-bold mb-6">Large Payloads</h2>
                <p>While Reproq handles complex data types, it's best practice to pass IDs instead of full objects to keep the database and IPC communication lean.</p>
                <ul>
                    <li><strong>IDs over Objects</strong>: Pass <code>user_id</code> and fetch the user in the task.</li>
                    <li><strong>1MB Output Limit</strong>: The Go worker captures up to 1MB of stdout from the task result. For larger results, use a database model or external storage.</li>
                    <li><strong>Payload Mode</strong>: The worker uses stdin by default. Inline payload mode exposes args in process listings and is disabled in production builds.</li>
                    <li><strong>Logs Persistence</strong>: Set <code>REPROQ_LOGS_DIR</code> to store stdout/stderr and surface paths via <code>task_runs.logs_uri</code>.</li>
                </ul>
                <p class="text-sm text-slate-600">The executor resolves Django settings from <code>spec.django.settings_module</code> or <code>DJANGO_SETTINGS_MODULE</code> and encodes payloads with deterministic JSON for stable spec hashing.</p>
            </section>

            <section id="periodic" class="mb-16 prose prose-slate max-w-none">
                <h2 class="text-3xl font-bold mb-6">Periodic Tasks</h2>
                <p>Manage cron schedules directly from the Django Admin or using the <code>PeriodicTask</code> model. Run either <code>reproq beat</code> or <code>reproq pg-cron</code> to trigger them.</p>
                <pre>from django.utils import timezone
from reproq_django.models import PeriodicTask

PeriodicTask.objects.update_or_create(
    name="Nightly cleanup",
    defaults={
        "cron_expr": "0 2 * * *",
        "task_path": "myapp.tasks.nightly_cleanup",
        "queue_name": "maintenance",
        "next_run_at": timezone.now(),
        "enabled": True,
    },
)</pre>
                <p class="text-sm text-slate-600">To run a schedule immediately, set <code>next_run_at</code> to <code>timezone.now()</code> or call the task's <code>enqueue()</code> method directly.</p>
                <ul>
                    <li><strong>cron_expr</strong>: standard 5-field cron syntax (min hour day month weekday).</li>
                    <li><strong>task_path</strong>: full Python import path for the task.</li>
                    <li><strong>queue_name</strong>: optional queue routing.</li>
                </ul>
            </section>

            <section id="rate-limits" class="mb-16 prose prose-slate max-w-none">
                <h2 class="text-3xl font-bold mb-6">Rate Limiting</h2>
                <p>Reproq Worker enforces token bucket limits stored in the <code>rate_limits</code> table. Limits are disabled by default; configure them in the Django Admin or via the worker CLI.</p>
                <ul>
                    <li><strong>queue:&lt;queue_name&gt;</strong>: Limit a queue.</li>
                    <li><strong>task:&lt;task_path&gt;</strong>: Limit a task (overrides queue/global).</li>
                    <li><strong>global</strong>: Fallback limit if no task/queue entry exists.</li>
                </ul>
                <pre>reproq limit set --key queue:default --rate 5 --burst 10</pre>
            </section>

            <section id="scaling" class="mb-16 prose prose-slate max-w-none">
                <h2 class="text-3xl font-bold mb-6">Scaling: Workers vs Concurrency</h2>
                <p>You can scale Reproq by increasing <code>--concurrency</code> or by running multiple workers.</p>
                <ul>
                    <li><strong>Concurrency</strong>: more goroutines in one process; best for I/O-heavy tasks with minimal overhead.</li>
                    <li><strong>Multiple workers</strong>: separate processes/hosts; best for CPU-heavy workloads and fault isolation.</li>
                </ul>
                <p>Start with 1-2 workers per host and tune <code>--concurrency</code> to available CPU cores and workload type.</p>
            </section>

            <section id="production" class="mb-16">
                <h2 class="text-3xl font-bold mb-6 text-slate-900 tracking-tight">Production Deployment</h2>
                <p class="text-slate-600 mb-6 text-lg">Reproq is production-ready and includes automated tools for Linux systemd configuration.</p>
                <p class="text-slate-600 mb-4 text-sm">For deploy-time tasks (like deploy notifications), enqueue them after the worker starts and guard with a deploy ID (for example, RENDER_DEPLOY_ID) so old workers do not claim them.</p>
                <p class="text-slate-600 mb-4 text-sm">If a worker crashes mid-task, reclaim stale leases with <code>python manage.py reproq reclaim --older-than 5m --action requeue</code>.</p>
                <p class="text-slate-600 mb-4 text-sm">If you expose metrics, bind to localhost or a private interface. Use <code>METRICS_ALLOW_CIDRS</code> to restrict access by IP/CIDR.</p>
                
                <div class="bg-slate-50 border border-slate-200 rounded-2xl p-8">
                    <h4 class="font-bold text-slate-800 mb-2">Automated systemd setup</h4>
                    <p class="text-slate-600 mb-4">Generate optimized service files for your specific project environment:</p>
                    <pre class="bg-slate-900 text-slate-50 p-4 rounded-xl mb-6">python manage.py reproq systemd --concurrency 25</pre>
                    
                    <p class="text-sm text-slate-500">This command creates service files that handle:</p>
                    <ul class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm text-slate-600 mt-2">
                        <li class="flex items-center"><svg class="w-4 h-4 mr-2 text-indigo-500" fill="currentColor" viewBox="0 0 20 20"><path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"></path></svg> Automatic restart on failure</li>
                        <li class="flex items-center"><svg class="w-4 h-4 mr-2 text-indigo-500" fill="currentColor" viewBox="0 0 20 20"><path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"></path></svg> Log rotation via journald</li>
                        <li class="flex items-center"><svg class="w-4 h-4 mr-2 text-indigo-500" fill="currentColor" viewBox="0 0 20 20"><path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"></path></svg> Zero-config environment detection</li>
                        <li class="flex items-center"><svg class="w-4 h-4 mr-2 text-indigo-500" fill="currentColor" viewBox="0 0 20 20"><path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"></path></svg> Boot-time auto-start</li>
                    </ul>
                </div>
            </section>


            <section id="admin" class="mb-16">
                <h2 class="text-3xl font-bold mb-6">Real-Time Dashboard</h2>
                <p class="text-slate-600 mb-4">Reproq includes a high-performance dashboard built into the Django Admin. Monitor worker health, task duration, and execution success in real-time.</p>
                <div class="bg-slate-900 rounded-xl p-8 text-center text-white shadow-2xl">
                    <div class="text-indigo-400 font-bold mb-2 uppercase tracking-widest text-xs">Live Dashboard Features</div>
                    <ul class="text-left space-y-2 text-sm inline-block">
                        <li class="flex items-center"><span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span> Auto-refreshing Task List (10s)</li>
                        <li class="flex items-center"><span class="w-2 h-2 bg-blue-500 rounded-full mr-2"></span> Worker Heartbeat Monitoring</li>
                        <li class="flex items-center"><span class="w-2 h-2 bg-purple-500 rounded-full mr-2"></span> Bulk Replay & Cancellation</li>
                        <li class="flex items-center"><span class="w-2 h-2 bg-indigo-500 rounded-full mr-2"></span> Visual Execution Timelines</li>
                    </ul>
                </div>
            </section>

            <section id="metrics" class="mb-16 prose prose-slate max-w-none">
                <h2 class="text-3xl font-bold mb-6">Prometheus Monitoring</h2>
                <p>The Go worker exports real-time performance metrics. For detailed configuration, see the <a href="https://adpena.github.io/reproq-worker/" class="text-indigo-600 font-bold">Reproq Worker Documentation</a>.</p>
            </section>

            <section id="community" class="mb-16">
                <h2 class="text-3xl font-bold mb-6">Join the Community</h2>
                <div class="p-8 bg-indigo-50 border border-indigo-100 rounded-2xl font-sans">
                    <p class="text-indigo-900 font-bold mb-4 text-xl tracking-tight">Reproq is an open-source project and we love contributions!</p>
                    <p class="text-indigo-700 mb-8 leading-relaxed text-lg">Whether you are fixing bugs, improving documentation, or suggesting new features, your help is welcome. We are specifically looking for feedback on developer experience (DX) and high-scale performance.</p>
                    <div class="flex gap-4">
                        <a href="https://github.com/adpena/reproq-django" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-bold rounded-xl shadow-lg text-white bg-indigo-600 hover:bg-indigo-700 transition-all">GitHub Repository</a>
                        <a href="https://github.com/adpena/reproq-django/issues" class="inline-flex items-center px-6 py-3 border-2 border-indigo-600 text-base font-bold rounded-xl text-indigo-600 bg-white hover:bg-indigo-50 transition-all">Report an Issue</a>
                    </div>
                </div>
            </section>

            <footer class="mt-24 pt-8 border-t border-slate-200 text-slate-400 text-sm flex justify-between">
                <div>&copy; 2025 Alejandro Pe√±a. Released under MIT License.</div>
                <div class="flex space-x-4">
                    <a href="https://github.com/adpena/reproq-django" class="hover:text-indigo-500">GitHub</a>
                </div>
            </footer>
        </main>
    </div>
</body>
</html>
